<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8"/>
  <title>soagen: A Structure-of-Arrays generator for C++ | soagen Structure-of-Arrays for C++</title>
  <link href="favicon-light.png" rel="icon" type="image/png"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="#cb4b16" name="theme-color"/>
  <link href="poxy/poxy.css" referrerpolicy="no-referrer" rel="stylesheet"/>
  <link href="pages.css" referrerpolicy="no-referrer" rel="stylesheet"/>
  <script src="poxy/poxy.js"></script>
  <script>initialize_theme("light");</script>
  <meta content="soagen" name="twitter:title"/>
  <meta content="soagen" property="og:title"/>
  <meta content="soagen" itemprop="name"/>
  <meta content="Mark Gillard" name="author"/>
  <meta content="Mark Gillard" property="article:author"/>
  <meta content="Structure-of-Arrays for C++" name="description"/>
  <meta content="Structure-of-Arrays for C++" name="twitter:description"/>
  <meta content="Structure-of-Arrays for C++" property="og:description"/>
  <meta content="Structure-of-Arrays for C++" itemprop="description"/>
  <meta content="telephone=no" name="format-detection"/>
  <meta content="Poxy v0.12.7" name="generator"/>
  <meta content="strict-origin-when-cross-origin" name="referrer"/>
</head>
<body class="poxy-has-toc">
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a class="m-col-t-8 m-col-m-none m-left-m" href="index.html" id="m-navbar-brand">soagen <span class="m-thin">Structure-of-Arrays for C++</span></a>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a class="m-doc-search-icon" href="#search" onclick="return showSearch()" title="Search"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path d="m6 0c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6 1.49 0 2.85-0.541 3.89-1.44-0.0164 0.338 0.147 0.759 0.5 1.15l3.22 3.79c0.552 0.614 1.45 0.665 2 0.115 0.55-0.55 0.499-1.45-0.115-2l-3.79-3.22c-0.392-0.353-0.812-0.515-1.15-0.5 0.895-1.05 1.44-2.41 1.44-3.89 0-3.31-2.69-6-6-6zm0 1.56a4.44 4.44 0 0 1 4.44 4.44 4.44 4.44 0 0 1-4.44 4.44 4.44 4.44 0 0 1-4.44-4.44 4.44 4.44 0 0 1 4.44-4.44z" id="m-doc-search-icon-path"></path>
        </svg></a>
        <a href="#navigation" id="m-navbar-show" title="Show navigation"></a>
        <a href="#" id="m-navbar-hide" title="Hide navigation"></a>
      </div>
      <div class="m-col-t-12 m-show-m m-col-m-none m-right-m" id="m-navbar-collapse">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li><a href="pages.html">Pages</a></li>
            <li><a href="namespaces.html">Namespaces</a></li>
            <li><a href="annotated.html">Classes</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="4">
            <li><a class="poxy-icon repo github poxy-external" href="https://github.com/marzer/soagen" target="_blank" title="View on GitHub"><svg id="poxy-repo-icon" version="1.1" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25,1.23a24.37,24.37,0,0,0-7.7,47.5C18.51,49,19,48.2,19,47.56s0-2.12,0-4.15c-6.78,1.47-8.21-3.27-8.21-3.27C9.61,37.33,8,36.58,8,36.58c-2.21-1.51.17-1.48.17-1.48a5.12,5.12,0,0,1,3.73,2.51c2.17,3.72,5.7,2.65,7.09,2a5.25,5.25,0,0,1,1.55-3.26c-5.41-.61-11.1-2.7-11.1-12A9.41,9.41,0,0,1,12,17.79a8.75,8.75,0,0,1,.24-6.45s2-.66,6.7,2.49a23.1,23.1,0,0,1,12.2,0c4.66-3.15,6.7-2.49,6.7-2.49A8.75,8.75,0,0,1,38,17.79a9.41,9.41,0,0,1,2.51,6.54c0,9.36-5.7,11.42-11.13,12a5.83,5.83,0,0,1,1.65,4.51c0,3.26,0,5.89,0,6.69,0,.65.44,1.41,1.68,1.17A24.38,24.38,0,0,0,25,1.23Z" fill="currentColor"></path></svg></a></li>
            <li><a class="poxy-icon theme" href="javascript:void(null);" id="poxy-theme-switch" onclick="toggle_theme(); return false;" role="button" title="Toggle dark and light themes"><svg id="poxy-theme-switch-img" version="1.1" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><circle cx="185.6708" cy="183.8122" fill="currentColor" r="65.625"></circle><path d="M185.6708,87.5622a13.1256,13.1256,0,0,0,13.125-13.125V52.5622a13.125,13.125,0,1,0-26.25,0v21.875A13.1257,13.1257,0,0,0,185.6708,87.5622Z" fill="currentColor"></path><path d="M99.051,115.7519a13.1236,13.1236,0,1,0,18.56-18.56L102.1442,81.726a13.1236,13.1236,0,0,0-18.5595,18.56Z" fill="currentColor"></path><path d="M89.4208,183.8122a13.1257,13.1257,0,0,0-13.125-13.125H54.4208a13.125,13.125,0,0,0,0,26.25h21.875A13.1256,13.1256,0,0,0,89.4208,183.8122Z" fill="currentColor"></path><path d="M99.051,251.8725,83.5847,267.3431a13.1236,13.1236,0,1,0,18.56,18.56l15.4663-15.4706a13.1236,13.1236,0,1,0-18.5595-18.56Z" fill="currentColor"></path><path d="M185.6708,280.0622a13.1258,13.1258,0,0,0-13.125,13.125v21.875a13.125,13.125,0,0,0,26.25,0v-21.875A13.1257,13.1257,0,0,0,185.6708,280.0622Z" fill="currentColor"></path><path d="M272.2907,251.8725a13.1236,13.1236,0,1,0-18.56,18.56l15.4663,15.4706a13.1236,13.1236,0,1,0,18.56-18.56Z" fill="currentColor"></path><path d="M330.0458,183.8122a13.1257,13.1257,0,0,0-13.125-13.125h-21.875a13.125,13.125,0,0,0,0,26.25h21.875A13.1256,13.1256,0,0,0,330.0458,183.8122Z" fill="currentColor"></path><path d="M263.0109,119.5971a13.0824,13.0824,0,0,0,9.28-3.8452l15.4663-15.4663a13.1236,13.1236,0,1,0-18.56-18.56L253.7312,97.1923a13.125,13.125,0,0,0,9.28,22.4048Z" fill="currentColor"></path><path d="M456.9379,401.6714a63.97,63.97,0,0,1-14.9963,7.2055c-19.6448,6.5283-41.8787,2.9566-58.1439-9.8523a68.9311,68.9311,0,0,1-10.835-10.8339c-12.8088-16.2663-16.3806-38.5-9.8523-58.1471a63.8444,63.8444,0,0,1,7.2077-14.9931,8.8036,8.8036,0,0,0-10.1172-13.3034,87.5188,87.5188,0,1,0,110.0372,110.04A8.8,8.8,0,0,0,456.9379,401.6714Z" fill="currentColor"></path></svg></a></li>
            <li class="m-show-m"><a class="m-doc-search-icon" href="#search" onclick="return showSearch()" title="Search"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <use href="#m-doc-search-icon-path"></use>
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          soagen: A Structure-of-Arrays generator for C++
        </h1>
        <nav class="m-block m-default poxy-toc" id="poxy-toc">
          <h3>Contents</h3>
          <ul>
            <li><a href="#intro_tldr">TL;DR</a></li>
            <li>
              <a href="#intro_motivation">Motivation</a>
              <ul>
                <li><a href="#intro_motivation_typical">Typical data layouts (Array-of-Structures)</a></li>
                <li>
                  <a href="#intro_motivation_soa">Structure-of-Arrays</a>
                  <ul>
                    <li><a href="#intro_motivation_soa_naive">A na√Øve implementation</a></li>
                    <li><a href="#intro_motivation_soa_multiple_allocation">Problem #1: Multiple allocations</a></li>
                    <li><a href="#intro_motivation_soa_manual_sync">Problem #2: Manual Synchronization</a></li>
                    <li><a href="#intro_motivation_soa_iterators_weakly_typed">Problem #3: Identities are weakly-typed</a></li>
                    <li><a href="#intro_motivation_soa_struct_mode_hard">Problem #4: AoS-style access is cumbersome</a></li>
                    <li><a href="#intro_motivation_soa_idiomatic">Problem #5: Not idiomatic C++</a></li>
                    <li><a href="#intro_motivation_soa_names">Problem #6: Elegance or Names - pick one</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <a href="#intro_introducing_soagen">Introducing soagen</a>
              <ul>
                <li><a href="#intro_introducing_soagen_getting_started">Getting started</a></li>
                <li><a href="#intro_introducing_soagen_creating_first_class">Creating your first SoA class</a></li>
                <li><a href="#intro_introducing_soagen_installing_soagen_hpp">Installing soagen.hpp</a></li>
              </ul>
            </li>
          </ul>
        </nav>
<section id="intro_tldr"><h2><a href="#intro_tldr">TL;DR</a></h2><p>The leading section of this page is an overview of what <a class="poxy-external" href="https://en.wikipedia.org/wiki/AoS_and_SoA" target="_blank">Structures-of-Arrays (SoA)</a> are, what problems they solve, and annoyances of working with them. Following that is an overview of <strong>soagen</strong> - a new Structure-Of-Arrays generator and library for C++.</p><p class="m-note m-success"> Skip to <a class="m-doc" href="intro.html#intro_introducing_soagen">Introducing soagen</a> if you already know all about SoA and want to go straight to learning about <strong>soagen</strong> instead.</p></section><section id="intro_motivation"><h2><a href="#intro_motivation">Motivation</a></h2><section id="intro_motivation_typical"><h3><a href="#intro_motivation_typical">Typical data layouts (Array-of-Structures)</a></h3><p>Data records in a typical C++ program will be organized into <code>structs</code> and/or <code>classes</code>, one per 'unit' type, and multiples of these will be stored in arrays. For example, a program for managing employee records might contain something akin to this:</p><pre class="m-code"><span class="k">struct</span> <span class="nc">employee</span>
<span class="p">{</span>
    <span class="k">unsigned</span> <span class="k">long</span> <span class="k">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="nn">std</span><span class="o">::</span><span class="nc">string</span> <span class="n">name</span><span class="p">;</span>
    <span class="nn">std</span><span class="o">::</span><span class="nc">tuple</span><span class="o">&lt;</span><span class="k">unsigned</span> <span class="k">short</span><span class="p">,</span> <span class="k">unsigned</span> <span class="k">char</span><span class="p">,</span> <span class="k">unsigned</span> <span class="k">char</span><span class="o">&gt;</span> <span class="n">dob</span><span class="p">;</span>
    <span class="k">int</span> <span class="n">salary</span><span class="p">;</span>
    <span class="c1">// ... plus a bunch more</span>
<span class="p">};</span></pre><p>And elsewhere in the program you'd almost certainly find this:</p><pre class="m-code"><span class="nn">std</span><span class="o">::</span><span class="nc">vector</span><span class="o">&lt;</span><span class="nc">employee</span><span class="o">&gt;</span> <span class="n">employees</span><span class="p">;</span></pre><p>This paradigm is broadly called <a class="poxy-external" href="https://en.wikipedia.org/wiki/AoS_and_SoA" target="_blank">Array-of-Structures</a> (AoS). Stored this way, the all employee members are laid out sequentially in memory, so the <code>employees</code> array would look like this:</p><table class="m-table"><thead><tr><th colspan="4">employees[0]</th><th colspan="4">employees[1]</th><th>‚Üí</th></tr></thead><tbody><tr><td><code>id</code></td><td><code>name</code></td><td><code>dob</code></td><td><code>salary</code></td><td><code>id</code></td><td><code>name</code></td><td><code>dob</code></td><td><code>salary</code></td><td>‚Üí</td></tr></tbody></table><p>When iterating over the <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/container/vector.html" target="_blank">std::<wbr/>vector</a></code> depicted above, the CPU's cache will be mostly (or entirely) filled by only a single <code>employee</code> at all times. This is likely fine - most tasks pertaining to <code>employee</code> objects are going to want to access multiple data members, so the linear layout is useful. Rare would be the situation where you'd need to loop over the <code>employees</code> and fetch only a single field.</p><p>What about scenarios where you <em>do</em> want to only manipulate a single field from many objects, though? Let's say the <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/container/vector.html" target="_blank">std::<wbr/>vector</a></code> example above had 1,000,000 <code>employee</code> elements and you wanted to query the total labour cost of your enormous company by summing up the <code>salary</code> member. Suddenly all those cache line misses start to add up and your <code>calculate_labour_cost()</code> routine is now much slower than you'd like.</p><p class="m-note m-default"> <em>Yes, yes, you wouldn't use C++ for this. It'd be in SQL or similar. This is an example. Put down your pitchforks.</em></p><p>Still, in the general case, the access patterns for an <code>employee</code> would benefit from the current layout far more than any gains made by restructuring to solve this one specific problem (doing so is likely to pessimize the rest of the program). Also consider that calls to <code>calculate_labour_cost()</code> would be infrequent and the result could be cached, making this problem even less worth solving.</p><p>Let's have a look at a situation where the problem very much <em>is</em> worth solving.</p></section><section id="intro_motivation_soa"><h3><a href="#intro_motivation_soa">Structure-of-Arrays</a></h3><section id="intro_motivation_soa_naive"><h4><a href="#intro_motivation_soa_naive">A na√Øve implementation</a></h4><p>Consider a game engine: game worlds are populated by entities, those entities have various characteristics (position, orientation, mesh, id, name, et cetera). Imagine we had those encapsulated by an <code>entity</code> struct:</p><pre class="m-code"><span class="k">struct</span> <span class="nc">entity</span>
<span class="p">{</span>
    <span class="k">unsigned</span> <span class="k">long</span> <span class="k">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="nn">std</span><span class="o">::</span><span class="nc">string</span> <span class="n">name</span><span class="p">;</span>
    <span class="nc">vec3</span> <span class="n">pos</span><span class="p">;</span>
    <span class="nc">quaternion</span> <span class="n">orient</span><span class="p">;</span>
    <span class="c1">// ... and so on</span>
<span class="p">};</span></pre><p>As before, lets have a look at what an array of these would look like in memory:</p><pre class="m-code"><span class="nn">std</span><span class="o">::</span><span class="nc">vector</span><span class="o">&lt;</span><span class="n">entity</span><span class="o">&gt;</span> <span class="n">entities</span><span class="p">;</span></pre><table class="m-table"><thead><tr><th colspan="4">entities[0]</th><th colspan="4">entities[1]</th><th>‚Üí</th></tr></thead><tbody><tr><td><code>id</code></td><td><code>name</code></td><td><code>pos</code></td><td><code>orient</code></td><td><code>id</code></td><td><code>name</code></td><td><code>pos</code></td><td><code>orient</code></td><td>‚Üí</td></tr></tbody></table><p>Game worlds feature many thousands of entities. Rendering these can be expensive, so great effort goes into ensuring the engine does not render anything unnecessarily. One technique for eliminating entities from the render list is to cull those that do not intersect with the camera's <a class="poxy-external" href="https://en.wikipedia.org/wiki/Viewing_frustum" target="_blank">view frustum</a>. This necessitates iterating over all the entities in the game world at least once every frame (assisted by a bounding volume hierarchy or other acceleration structure). Unlike the <code>employee</code> program above, taking constant cache misses during this iteration by reading in entire <code>entity</code> structs is potentially devastating to our frame time!</p><p>Ideally we want to <em>only</em> read in the parts of the entities we care about (e.g. <code>entity::pos</code>), without dragging anything else into the cache.</p><p>Enter: ‚ú®Ô∏è <a class="poxy-external" href="https://en.wikipedia.org/wiki/AoS_and_SoA" target="_blank">Structure-of-Arrays</a>. ‚ú®Ô∏è</p><p>If we restructured our entities into a series of parallel <code><a class="m-doc poxy-injected poxy-external" href="https://en.cppreference.com/w/cpp/container/vector" target="_blank">std::vectors</a></code>, we could iterate over just the positions:</p><pre class="m-code"><span class="k">struct</span> <span class="nc">entities</span>
<span class="p">{</span>
    <span class="nn">std</span><span class="o">::</span><span class="nc">vector</span><span class="o">&lt;</span><span class="k">unsigned</span> <span class="k">long</span> <span class="k">long</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">;</span>
    <span class="nn">std</span><span class="o">::</span><span class="nc">vector</span><span class="o">&lt;</span><span class="nn">std</span><span class="o">::</span><span class="nc">string</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">;</span>
    <span class="nn">std</span><span class="o">::</span><span class="nc">vector</span><span class="o">&lt;</span><span class="nc">vec3</span><span class="o">&gt;</span> <span class="n">pos</span><span class="p">;</span>
    <span class="nn">std</span><span class="o">::</span><span class="nc">vector</span><span class="o">&lt;</span><span class="nc">quaternion</span><span class="o">&gt;</span> <span class="n">orientation</span><span class="p">;</span>
    <span class="c1">// ... and so on</span>
<span class="p">};</span></pre><p>Now our data is conceptually more like a table, with columns for each characteristic (stored contiguously), and rows for each individual element:</p><table class="m-table"><thead><tr><th></th><th>id</th><th>name</th><th>pos</th><th>orient</th></tr></thead><tbody><tr><th>element 0</th><td><code>id[0]</code></td><td><code>name[0]</code></td><td><code>pos[0]</code></td><td><code>orient[0]</code></td></tr><tr><th>element 1</th><td><code>id[1]</code></td><td><code>name[1]</code></td><td><code>pos[1]</code></td><td><code>orient[1]</code></td></tr><tr><th>element 2</th><td><code>id[2]</code></td><td><code>name[2]</code></td><td><code>pos[2]</code></td><td><code>orient[2]</code></td></tr><tr><th>‚Üì</th><td>‚Üì</td><td>‚Üì</td><td>‚Üì</td><td>‚Üì</td></tr></tbody></table><p>We've lost the explicit <code>entity</code> class for representing one single game world entity, and have instead transitioned to an implicit object model where an entity is described by all the elements sharing the same index in the parallel <code><a class="m-doc poxy-injected poxy-external" href="https://en.cppreference.com/w/cpp/container/vector" target="_blank">std::vectors</a></code>. As well as being faster for single-element iteration, this also has another neat side-effect: no structs means no padding between struct members, so lower memory usage!</p><p>‚ö†Ô∏è There are some big problems with this na√Øve SoA implementation, though.</p></section><section id="intro_motivation_soa_multiple_allocation"><h4><a href="#intro_motivation_soa_multiple_allocation">Problem #1: Multiple allocations</a></h4><p>One heap allocation for each member <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/container/vector.html" target="_blank">std::<wbr/>vector</a></code>. Sure we could come up with a custom <code>allocator</code> that works from the same internal buffer, but that's not for the faint of heart.</p><p class="m-note m-default"> <em>No doubt there's some solution for this in <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/namespacestd_1_1pmr.html" target="_blank">std::<wbr/>pmr</a></code>. I'll leave that as an exercise for the reader.</em></p></section><section id="intro_motivation_soa_manual_sync"><h4><a href="#intro_motivation_soa_manual_sync">Problem #2: Manual Synchronization</a></h4><p>Now that we have multiple arrays, we must ensure that they are all updated in unison whenever we insert, modify, or delete elements. Forgetting to do this at any point will mean the parallel members are no longer in sync and lead to disastrous and hilarious effects.</p></section><section id="intro_motivation_soa_iterators_weakly_typed"><h4><a href="#intro_motivation_soa_iterators_weakly_typed">Problem #3: Identities are weakly-typed</a></h4><p>We no longer have the benefit of the strongly-typed <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/container/vector.html" target="_blank">std::<wbr/>vector</a>&lt;entity&gt;::iterator</code> (or even just the ability to take a pointer, <code>entity*</code>), so any time we need to store an association between a specific entity and some other thing, it needs to be done via an index (e.g. <code><a class="m-doc poxy-injected poxy-external" href="https://en.cppreference.com/w/cpp/types/size_t" target="_blank">size_t</a></code>). This is much more error-prone; it's all-too-easy easy to accidentally treat an index into one collection as an index into another.</p><p>Using a 'strong type' library (like <a class="poxy-external" href="https://github.com/rollbear/strong_type" target="_blank">this one</a>) or using an <code>enum class</code> can help here, but that still means you need <code>static_casts</code> (or some other conversion function) everywhere, which is <em>very annoying</em>.</p></section><section id="intro_motivation_soa_struct_mode_hard"><h4><a href="#intro_motivation_soa_struct_mode_hard">Problem #4: AoS-style access is cumbersome</a></h4><p>There will always be situations where you need to treat your SoA data as if it were AoS. Debug printing, for example. Code that needs to work in AoS mode is now littered with <code>operator[]</code> invocations, making it uglier and more error prone.</p></section><section id="intro_motivation_soa_idiomatic"><h4><a href="#intro_motivation_soa_idiomatic">Problem #5: Not idiomatic C++</a></h4><p>AoS-style data means we can call <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/container/vector.html" target="_blank">std::<wbr/>vector</a>&lt;&gt;::push_back()</code> to add an entirely new self-contained record. We can call <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/algorithm/sort.html" target="_blank">std::<wbr/>sort()</a></code> on the elements in that vector. We can get the <code>begin()</code> and <code>end()</code> iterators. And so on. These are idioms all C++ programmers are innately familiar with. SoA-style data can make these tasks much harder, typically necessitating a new set of internal idioms and reducing the understandability of the code.</p></section><section id="intro_motivation_soa_names"><h4><a href="#intro_motivation_soa_names">Problem #6: Elegance or Names - pick one</a></h4><p>There are a number of solutions for the problems described above floating around the internet. All of them boil down to one of two approaches:</p><ol><li>Most/all of the problems above are solved using a nice template syntax and some specialization tricks, but you lose the names of members and instead need to fall-back to the incredibly unfrendly <a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/utility/tuple.html" target="_blank">std::<wbr/>tuple</a>-like <code>entities.get&lt;0&gt;()[N]</code>.</li><li>You get names, yay! But now your codebase is filled with macros, boo.</li></ol><p>Of the two options above, I generally prefer #2, though having to update lists of template specialization macros whenever you make changes to an SoA container is also a source of error. Without language-level reflection facilities, any solution with names is going to have macros <em>somewhere</em>.</p><aside class="m-note m-special"><p>  We're pretty much done explaining AoS vs SoA now, but if these concepts were new for you and you'd like to learn more about them before you move on to read about <strong>soagen</strong>, here's some resources:</p><ul><li><a class="poxy-external" href="https://en.wikipedia.org/wiki/AoS_and_SoA" target="_blank">AoS and SoA</a> - Wikipedia</li><li><a class="poxy-external" href="https://blog.molecular-matters.com/2013/10/22/implementing-a-semi-automatic-structure-of-arrays-data-container/" target="_blank">Implementing a semi-automatic structure-of-arrays data container</a> - Molecular Matters</li><li><a class="poxy-external" href="https://www.intel.com/content/www/us/en/developer/articles/technical/memory-layout-transformations.html" target="_blank">Memory Layout Transformations</a> - Intel</li><li><a class="poxy-external" href="https://saturncloud.io/blog/structure-of-arrays-vs-array-of-structures-in-cuda/" target="_blank">Structure of Arrays vs Array of Structures in CUDA</a> - SaturnCloud</li></ul></aside></section></section></section><section id="intro_introducing_soagen"><h2><a href="#intro_introducing_soagen">Introducing soagen</a></h2><p>I'd to present my solution to the problems of working with Structure-of-Arrays in C++: <strong>soagen</strong>. Soagen is fundamentally two things:</p><ol><li><a class="poxy-external" href="https://pypi.org/project/soagen" target="_blank"><code>soagen</code></a>, a command-line code generator for generating <code><a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/container/vector.html" target="_blank">std::<wbr/>vector</a></code>-like SoA classes</li><li><a class="poxy-external" href="https://github.com/marzer/soagen/blob/main/src/soagen/hpp/single/soagen.hpp" target="_blank"><code>soagen.hpp</code></a>, a single-header backing library upon which the generated code depends</li></ol><p>Typically you only need to use the command-line tool <a class="poxy-external" href="https://pypi.org/project/soagen" target="_blank"><code>soagen</code></a>, and don't need to know anything about <a class="poxy-external" href="https://github.com/marzer/soagen/blob/main/src/soagen/hpp/single/soagen.hpp" target="_blank"><code>soagen.hpp</code></a> beyond <em>"this needs to go in my source tree somewhere"</em> (as it's largely an implementation detail). You might need to learn more about the backing library if you're doing more advanced stuff, but we'll cover that later.</p><p>I'll go over how to use <a class="poxy-external" href="https://pypi.org/project/soagen" target="_blank"><code>soagen</code></a>, and the code it generates, by demonstrating how to we'd use it to create a nice SoA version of the <code>entity</code> class <a href="#intro_motivation_soa_naive">described above</a>.</p><p class="m-note m-default"> <em>Intermezzo: I stylize the name as 'soagen' (all lowercase), only capitalizing the S when it's the first word in a sentence, but I don't feel strongly about it. Render it however you like, I'm not fussed. SoAgen, Soagen, SOAgen, whatever.</em></p><section id="intro_introducing_soagen_getting_started"><h3><a href="#intro_introducing_soagen_getting_started">Getting started</a></h3><p><a class="poxy-external" href="https://pypi.org/project/soagen" target="_blank"><code>soagen</code></a> is a command-line application written in python. Grab it using pip</p><pre class="m-code">&gt; pip install soagen</pre><p>After that, let's take a look at the help output:</p><pre class="m-code">&gt; soagen --help

usage: soagen [-h] [-v] [--version] [--install &lt;dir&gt;] [--werror | --no-werror]
              [--color | --no-color] [--clang-format | --no-clang-format]
              [--doxygen | --no-doxygen] [--natvis | --no-natvis] [--bug-report]
              [configs ...]

  ___  ___   __ _  __ _  ___ _ __
 / __|/ _ \ / _` |/ _` |/ _ \ '_ \
 \__ \ (_) | (_| | (_| |  __/ | | |
 |___/\___/ \__,_|\__, |\___|_| |_|
                   __/ |
                  |___/   v0.1.0 - github.com/marzer/soagen

Struct-of-Arrays generator for C++ projects.

positional arguments:
  configs               zero or more .toml files describing your structures-of-arrays
                        (wildcards are accepted, e.g. soa/*.toml)

options:
  -h, --help            show this help message and exit
  -v, --verbose         enable very noisy diagnostic output
  --version             print the version and exit
  --install &lt;dir&gt;       install soagen.hpp into a directory
  --werror, --no-werror
                        treat warnings as errors (default: False)
  --color, --no-color   use colors in terminal output (default: True)
                        (the British spelling "colour" is also accepted)
  --clang-format, --no-clang-format
                        attempt to run clang-format on generated code (default: True)
  --doxygen, --no-doxygen
                        include doxygen markup in the generated code (default: False)
  --natvis, --no-natvis
                        generate .natvis files for Visual Studio (default: True)
  --bug-report          capture all inputs and outputs in a bug-report zip file</pre><p>So we need to do two things:</p><ol><li>Tell <code>soagen</code> about the structs we want via a <code>.toml</code> file</li><li>Install <a class="poxy-external" href="https://github.com/marzer/soagen/blob/main/src/soagen/hpp/single/soagen.hpp" target="_blank"><code>soagen.hpp</code></a> somewhere (e.g. <code>my_game/src</code>)</li></ol></section><section id="intro_introducing_soagen_creating_first_class"><h3><a href="#intro_introducing_soagen_creating_first_class">Creating your first SoA class</a></h3><p><code>soagen</code> creates the output <code>XXXX.hpp</code> next to each <code>XXXX.toml</code> input you pass in. Given a game project with a fairly standard file structure:</p><pre class="m-code">docs/
include/
src/
README.md
... etc</pre><p>...if we want <a class="poxy-external" href="https://github.com/marzer/soagen/blob/main/examples/entities.hpp" target="_blank"><code>entities.hpp</code></a> to end up in <code>src/</code> because it's an implementation detail, then that's where the soagen configuration file <code>entities.toml</code> should go, too. Let's create <code>src/entities.toml</code> populate it thus:</p><pre class="m-code"><span class="n">namespace</span> <span class="o">=</span> <span class="s">'game'</span>

<span class="k">[structs.entities]</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s">'id'</span><span class="p">,</span>          <span class="n">type</span> <span class="o">=</span> <span class="s">'unsigned long long'</span><span class="p">},</span>
    <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>        <span class="n">type</span> <span class="o">=</span> <span class="s">'<a class="m-doc poxy-injected poxy-external" href="https://en.cppreference.com/w/cpp/string/basic_string" target="_blank">std::string</a>'</span><span class="p">},</span>
    <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s">'position'</span><span class="p">,</span>    <span class="n">type</span> <span class="o">=</span> <span class="s">'vec3'</span><span class="p">},</span>
    <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s">'orientation'</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">'quaternion'</span><span class="p">},</span>
<span class="p">]</span></pre><p class="m-note m-default"> <em>There are many more options in the soagen config schema but for now we'll just stick with the basics.</em></p><p>Now run <code>soagen</code>:</p><pre class="m-code">&gt; soagen src/*.toml

soagen v0.1.0
Reading src/entities.toml
Running clang-format for src/entities.hpp
Writing src/entities.hpp
Writing src/entities.natvis
All done!</pre><p>We now have <a class="poxy-external" href="https://github.com/marzer/soagen/blob/main/examples/entities.hpp" target="_blank"><code>src/entities.hpp</code></a> containing the definition of <code>game::entities</code>, a <a class="m-doc-external poxy-external" href="http://en.cppreference.com/w/cpp/container/vector.html" target="_blank">std::<wbr/>vector</a>-like SoA class (<a href="classsoagen_1_1examples_1_1entities.html">here's the documentation</a> if you'd like to see the API).</p><aside class="m-note m-info"><h4>Note</h4><p>Soagen has also generated a <a class="poxy-external" href="https://learn.microsoft.com/en-us/visualstudio/debugger/create-custom-views-of-native-objects?view=vs-2022#BKMK_Using_Natvis_files" target="_blank"><code>.natvis</code></a> file for working with Visual Studio, though this isn't mandatory - it can be disabled by passing <code>--no-natvis</code>.</p></aside><p>Our project now looks like this:</p><pre class="m-code">docs/
include/
src/
    entities.hpp
    entities.natvis
    entities.toml
README.md</pre></section><section id="intro_introducing_soagen_installing_soagen_hpp"><h3><a href="#intro_introducing_soagen_installing_soagen_hpp">Installing soagen.hpp</a></h3><div class="m-block m-badge m-primary about-the-author"> <img alt="The Author" src="author.jpg"/> <h3>About the author</h3> <p> I'm <a class="poxy-external" href="https://github.com/marzer" target="_blank">Mark</a>. I write code. Some of it is alright. Almost all of it is C++. You might know me as the <a class="poxy-external" href="https://github.com/marzer/tomlplusplus" target="_blank">toml++</a> guy. <span class="socials"> <a class="poxy-external" href="https://github.com/marzer" target="_blank"><svg class="poxy-injected-svg" id="poxy-injected-svg-0" version="1.1" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25,1.23a24.37,24.37,0,0,0-7.7,47.5C18.51,49,19,48.2,19,47.56s0-2.12,0-4.15c-6.78,1.47-8.21-3.27-8.21-3.27C9.61,37.33,8,36.58,8,36.58c-2.21-1.51.17-1.48.17-1.48a5.12,5.12,0,0,1,3.73,2.51c2.17,3.72,5.7,2.65,7.09,2a5.25,5.25,0,0,1,1.55-3.26c-5.41-.61-11.1-2.7-11.1-12A9.41,9.41,0,0,1,12,17.79a8.75,8.75,0,0,1,.24-6.45s2-.66,6.7,2.49a23.1,23.1,0,0,1,12.2,0c4.66-3.15,6.7-2.49,6.7-2.49A8.75,8.75,0,0,1,38,17.79a9.41,9.41,0,0,1,2.51,6.54c0,9.36-5.7,11.42-11.13,12a5.83,5.83,0,0,1,1.65,4.51c0,3.26,0,5.89,0,6.69,0,.65.44,1.41,1.68,1.17A24.38,24.38,0,0,0,25,1.23Z" fill="currentColor"></path></svg></a>
						<a class="poxy-external" href="https://twitter.com/marzer8789" target="_blank"><svg class="poxy-injected-svg" id="poxy-injected-svg-1" version="1.1" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M 50.0625 10.4375 C 48.214844 11.257813 46.234375 11.808594 44.152344 12.058594 C 46.277344 10.785156 47.910156 8.769531 48.675781 6.371094 C 46.691406 7.546875 44.484375 8.402344 42.144531 8.863281 C 40.269531 6.863281 37.597656 5.617188 34.640625 5.617188 C 28.960938 5.617188 24.355469 10.21875 24.355469 15.898438 C 24.355469 16.703125 24.449219 17.488281 24.625 18.242188 C 16.078125 17.8125 8.503906 13.71875 3.429688 7.496094 C 2.542969 9.019531 2.039063 10.785156 2.039063 12.667969 C 2.039063 16.234375 3.851563 19.382813 6.613281 21.230469 C 4.925781 21.175781 3.339844 20.710938 1.953125 19.941406 C 1.953125 19.984375 1.953125 20.027344 1.953125 20.070313 C 1.953125 25.054688 5.5 29.207031 10.199219 30.15625 C 9.339844 30.390625 8.429688 30.515625 7.492188 30.515625 C 6.828125 30.515625 6.183594 30.453125 5.554688 30.328125 C 6.867188 34.410156 10.664063 37.390625 15.160156 37.472656 C 11.644531 40.230469 7.210938 41.871094 2.390625 41.871094 C 1.558594 41.871094 0.742188 41.824219 -0.0585938 41.726563 C 4.488281 44.648438 9.894531 46.347656 15.703125 46.347656 C 34.617188 46.347656 44.960938 30.679688 44.960938 17.09375 C 44.960938 16.648438 44.949219 16.199219 44.933594 15.761719 C 46.941406 14.3125 48.683594 12.5 50.0625 10.4375 Z" fill="currentColor"></path></svg></a>
						<a class="poxy-external" href="mailto:mark.gillard@outlook.com.au" target="_blank"><svg class="poxy-injected-svg" fill="currentColor" id="poxy-injected-svg-2" version="1.1" viewBox="0 0 395 395" xmlns="http://www.w3.org/2000/svg"><g><polygon points="395,320.089 395,74.911 258.806,197.5  "></polygon><polygon points="197.5,252.682 158.616,217.682 22.421,340.271 372.579,340.271 236.384,217.682  "></polygon><polygon points="372.579,54.729 22.421,54.729 197.5,212.318  "></polygon><polygon points="0,74.911 0,320.089 136.194,197.5  "></polygon></g></svg></a> </span> </p> </div></section></section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-doc-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-doc-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">‚Ä¶</div>
        </div>
        <div class="m-doc-search-content">
          <form>
            <input autocomplete="off" autofocus="autofocus" disabled="disabled" id="search-input" name="q" placeholder="Loading ‚Ä¶" spellcheck="false" type="search"/>
          </form>
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript.</noscript>
          <div class="m-text m-dim m-text-center" id="search-help">
            <p class="m-noindent">Search for symbols, directories, files, pages or
            modules. You can omit any prefix from the symbol or file path; adding a
            <code>:</code> or <code>/</code> suffix lists all members of given symbol or
            directory.</p>
            <p class="m-noindent">Use <span class="m-label m-dim">‚Üì</span>
            / <span class="m-label m-dim">‚Üë</span> to navigate through the list,
            <span class="m-label m-dim">Enter</span> to go.
            <span class="m-label m-dim">Tab</span> autocompletes common prefix, you can
            copy a link to the result using <span class="m-label m-dim">‚åò</span>
            <span class="m-label m-dim">L</span> while <span class="m-label m-dim">‚åò</span>
            <span class="m-label m-dim">M</span> produces a Markdown link.</p>
          </div>
          <div class="m-text m-warning m-text-center" id="search-notfound">Sorry, nothing was found.</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search-v2.js"></script><script>install_mcss_search_shim();</script>
<script async="async" src="searchdata-v2.js"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        
<a class="poxy-external" href="https://github.com/marzer/soagen" target="_blank">GitHub</a>
‚Ä¢ <a class="poxy-external" href="https://github.com/marzer/soagen/issues" target="_blank">Report an issue</a>
‚Ä¢ <a href="poxy_changelog.html">Changelog</a>
‚Ä¢ <a class="poxy-external" href="https://github.com/marzer/soagen/blob/master/LICENSE" target="_blank">License</a>
‚Ä¢ <a download="" href="soagen.tagfile.xml" target="_blank" type="text/xml">Doxygen tagfile</a>
<br/><br/>
Site generated using <a class="poxy-external" href="https://github.com/marzer/poxy/" target="_blank">Poxy</a>

      </div>
    </div>
  </div>
</nav></footer>


</body></html>